<div class="flex items-center justify-between mb-3">
  <h2 class="text-lg font-semibold">Budget Alerts</h2>
  <button
    pButton
    type="button"
    label="Re-check"
    icon="pi pi-refresh"
    class="p-button-sm"
    (click)="recheck()"
  ></button>
</div>

<p-card class="shadow-sm">
  <ul class="divide-y">
    <li *ngFor="let a of alerts()" class="py-3 flex items-center justify-between">
      <div>
        <div class="font-medium">{{ a.teamName || a.team || 'Team' }}</div>
        <div class="text-xs text-gray-500">{{ a.message || 'Threshold reached' }}</div>
      </div>
      <p-tag
        [value]="a.level || 'warning'"
        [severity]="a.level === 'critical' ? 'danger' : 'warn'"
      ></p-tag>
    </li>
    <li *ngIf="alerts().length === 0" class="py-3 text-sm text-gray-500">
      No alerts at the moment
    </li>
  </ul>
</p-card>

<div class="grid mt-4 gap-4">
  <p-card header="Email Service" class="shadow-sm">
    <div class="flex flex-col md:flex-row md:items-end gap-3">
      <div class="flex-1">
        <label class="block text-sm mb-1">Send test email</label>
        <input
          pInputText
          type="email"
          placeholder="recipient@example.com"
          [ngModel]="testEmail()"
          (ngModelChange)="testEmail.set($event)"
          class="w-full"
        />
        <small *ngIf="testEmailSuccess() === true" class="text-green-600">{{
          testEmailMessage()
        }}</small>
        <small *ngIf="testEmailSuccess() === false" class="text-red-600">{{
          testEmailMessage()
        }}</small>
      </div>
      <button
        pButton
        type="button"
        label="Send"
        icon="pi pi-send"
        class="p-button-sm"
        (click)="sendTest()"
      ></button>
      <button
        pButton
        type="button"
        label="Check services"
        icon="pi pi-check-circle"
        class="p-button-sm p-button-text"
        (click)="checkServices()"
      ></button>
    </div>
    <div class="mt-3 text-sm text-gray-600" *ngIf="serviceStatus() as s">
      <div class="flex flex-wrap gap-4">
        <div>
          Email configured:
          <span [class]="s.email?.brevoConfigured ? 'text-green-600' : 'text-orange-600'">{{
            s.email?.brevoConfigured ? 'Yes' : 'No'
          }}</span>
        </div>
        <div>
          Sender set:
          <span [class]="s.email?.senderConfigured ? 'text-green-600' : 'text-orange-600'">{{
            s.email?.senderConfigured ? 'Yes' : 'No'
          }}</span>
        </div>
        <div>
          AI status:
          <span [class]="s.ai?.ok ? 'text-green-600' : 'text-orange-600'">{{
            s.ai?.ok ? 'OK' : 'Degraded'
          }}</span>
        </div>
        <div>Last checked: {{ s.timestamp | date : 'short' }}</div>
      </div>
    </div>
  </p-card>

  <p-card header="Maintenance" class="shadow-sm">
    <div class="flex items-center justify-between">
      <div class="text-sm text-gray-600">
        Reset budget alert flags for all teams and re-check thresholds.
      </div>
      <button
        pButton
        type="button"
        label="Reset & Re-check"
        icon="pi pi-history"
        class="p-button-sm"
        (click)="resetAlerts()"
      ></button>
    </div>
  </p-card>
</div>
